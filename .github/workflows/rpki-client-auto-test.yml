name: rpki-client auto regression

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check:
    runs-on: self-hosted
    outputs:
      latest: ${{ steps.latest.outputs.latest }}
      should_run: ${{ steps.diff.outputs.should_run }}
    steps:
      - uses: actions/checkout@v4

      - name: Get latest rpki-client-portable release tag
        id: latest
        run: |
          set -euo pipefail
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, urllib.request
          url = "https://api.github.com/repos/rpki-client/rpki-client-portable/releases/latest"
          data = json.loads(urllib.request.urlopen(url).read().decode("utf-8"))
          tag = data["tag_name"].strip()
          if tag.startswith("v"):
            tag = tag[1:]
          print(f"latest={tag}")
          PY

      - name: Compare with LAST_TESTED_VERSION
        id: diff
        run: |
          set -euo pipefail
          LATEST="${{ steps.latest.outputs.latest }}"
          LAST="$(tr -d '\r\n' < LAST_TESTED_VERSION 2>/dev/null || true)"
          echo "latest=$LATEST"
          echo "last=$LAST"
          if [ -z "$LAST" ] || [ "$LATEST" != "$LAST" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  test:
    needs: check
    if: needs.check.outputs.should_run == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build docker image for latest version
        run: |
          set -euo pipefail
          VERSION="${{ needs.check.outputs.latest }}"
          docker build --build-arg RPKI_CLIENT_VERSION="$VERSION" -t rpki-client-test:latest .

      - name: Run all container wrapper scripts (ordered)
        run: |
          set -euo pipefail
          VERSION="${{ needs.check.outputs.latest }}"

          mkdir -p logs
          echo "[INFO] Testing rpki-client version: $VERSION" | tee logs/00_version.txt

          mapfile -t files < <(ls -1 run_*_in_container.sh)

          for f in "${files[@]}"; do
            bn="$(basename "$f")"
            num="$(printf '%s' "$bn" | sed -n 's/^run_\([0-9]\+\)_\([0-9]\+\)-\([0-9]\+\).*$/\1.\2-\3/p')"
            if [ -z "$num" ]; then
              echo "[FAIL] 想定外のファイル名です（run_X_Y-Z_... を期待）: $bn" | tee -a logs/00_runner.txt
              exit 1
            fi
            echo "$num $f"
          done \
          | awk '
              {
                split($1, a, /[.-]/);
                printf "%03d %03d %03d %s\n", a[1], a[2], a[3], $2
              }
            ' \
          | sort \
          | awk '{print $4}' \
          | while read -r f; do
              echo "========== $f ==========" | tee -a logs/00_runner.txt
              bash "$f" 2>&1 | tee "logs/${f}.log"
            done

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpki-client-test-logs-${{ needs.check.outputs.latest }}
          path: logs/

      - name: Update LAST_TESTED_VERSION
        run: |
          set -euo pipefail
          echo "${{ needs.check.outputs.latest }}" > LAST_TESTED_VERSION

      - name: Create PR for LAST_TESTED_VERSION update
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update LAST_TESTED_VERSION to ${{ needs.check.outputs.latest }}"
          title: "chore: tested rpki-client ${{ needs.check.outputs.latest }}"
          body: "Automated update after running the regression suite."
          branch: ci/update-last-tested-version

